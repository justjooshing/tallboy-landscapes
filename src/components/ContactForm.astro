<form class="contact-form" id="contact-form">
  <div class="honeypot" aria-hidden="true">
    <label for="hp-box">Leave this unchecked</label>
    <input
      type="checkbox"
      name="hpBox"
      id="hp-box"
      tabindex="-1"
      autocomplete="off"
    />
  </div>
  <div class="form-row">
    <input type="text" name="firstName" placeholder="First Name" required />
    <input type="text" name="lastName" placeholder="Last Name" required />
  </div>
  <div class="form-row">
    <input type="email" name="email" placeholder="Email" />
    <input type="tel" name="phone" placeholder="Phone" required />
  </div>
  <textarea
    placeholder="Tell us about your project..."
    rows="4"
    name="message"
    required></textarea>
  <button type="submit" class="submit-btn"> Get Started </button>
</form>
<div
  id="contact-toast"
  class="toast"
  role="status"
  aria-live="polite"
  aria-hidden="true"
>
</div>

<style>
  .contact-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 600px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .contact-form input,
  .contact-form textarea {
    padding: 0.875rem 1.125rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.05);
    color: white;
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.95rem;
  }

  .contact-form input::placeholder,
  .contact-form textarea::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .contact-form input:focus,
  .contact-form textarea:focus {
    outline: none;
    border-color: var(--sage-green);
    background: rgba(255, 255, 255, 0.08);
  }

  .submit-btn {
    background: var(--sage-green);
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    transition: background 0.3s;
    width: fit-content;
  }

  .submit-btn:hover {
    background: var(--terracotta);
  }

  @media (min-width: 768px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* Honeypot visually hidden off-screen so normal users won't interact */
  .honeypot {
    position: absolute;
    left: -9999px;
    top: auto;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }

  /* Toast */
  .toast {
    position: fixed;
    left: 50%;
    transform: translateX(-50%) translateY(12px);
    bottom: 1rem;
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
    opacity: 0;
    pointer-events: none;
    transition:
      opacity 180ms ease,
      transform 180ms ease;
    z-index: 1000;
    font-size: 0.95rem;
  }

  .toast.visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateX(-50%) translateY(0);
  }

  .toast.success {
    background: rgba(34, 197, 94, 0.95); /* green */
    color: white;
  }

  .toast.error {
    background: rgba(220, 38, 38, 0.95); /* red */
    color: white;
  }
</style>

<script>
  import emailjs from "@emailjs/browser";

  import {
    // @ts-expect-error doesn't expect these to exist
    PUBLIC_EMAILJS_SERVICE_ID,
    // @ts-expect-error doesn't expect these to exist
    PUBLIC_EMAILJS_TEMPLATE_ID,
    // @ts-expect-error doesn't expect these to exist
    PUBLIC_EMAILJS_PUBLIC_KEY,
  } from "astro:env/client";

  const form = document.getElementById("contact-form");
  const toastEl = document.getElementById("contact-toast");
  let toastTimeout: number;

  if (form instanceof HTMLFormElement === true) {
    function showToast(type: "success" | "error", message: string) {
      if (!toastEl) return;
      window.clearTimeout(toastTimeout);
      toastEl.innerText = message;
      toastEl.className = `toast visible ${type}`;
      toastEl.setAttribute("aria-hidden", "false");
      toastTimeout = window.setTimeout(() => {
        toastEl.className = "toast";
        toastEl.setAttribute("aria-hidden", "true");
      }, 2000);
    }
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Honeypot check: abort if hidden checkbox is checked (likely a bot)
      const hp = form.querySelector('input[name="hpBox"]');
      if (hp instanceof HTMLInputElement && hp.checked) {
        console.warn("Honeypot triggered â€” aborting submit");
        return;
      }

      const data = new FormData(form);
      const templateParams = {
        firstName: data.get("firstName"),
        lastName: data.get("lastName"),
        email: data.get("email"),
        phone: data.get("phone"),
        message: data.get("message"),
      };

      try {
        await emailjs.send(
          PUBLIC_EMAILJS_SERVICE_ID,
          PUBLIC_EMAILJS_TEMPLATE_ID,
          templateParams,
          PUBLIC_EMAILJS_PUBLIC_KEY,
        );

        showToast("success", "Message sent!\nResetting form");
        setTimeout(() => {
          form.reset();
        }, 2000);
      } catch (err) {
        console.error("EmailJS error:", err);
        showToast("error", "Failed to send message");
      }
    });
  }
</script>
